#!/bin/bash

# === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
SERVER_USER="root"                 # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
SERVER_IP="188.120.246.132"        # IP-–∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞
SERVER_PATH="/var/www/snova"       # –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
NGINX_CONF="/etc/nginx/sites-available/snova" # –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É Nginx
VITE_PORT="5173"                   # –ü–æ—Ä—Ç, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ä–∞–±–æ—Ç–∞–µ—Ç Vite
BACKEND_DIR="server"               # –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–∞–ø–∫–∞ —Å –±—ç–∫–µ–Ω–¥–æ–º
FRONTEND_DIR="."                   # –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
REMOTE_BACKEND_DIR="$SERVER_PATH/server" # –ü–∞–ø–∫–∞ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
REMOTE_FRONTEND_DIR="$SERVER_PATH/frontend" # –ü–∞–ø–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

# === 1. –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –ª–æ–∫–∞–ª—å–Ω–æ ===
echo "üõ†  –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
rm -rf dist
npm install && npm run build || { echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞"; exit 1; }

# === 2. –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ===
echo "üöÄ –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
rsync -avz --delete dist/ "$SERVER_USER@$SERVER_IP:$REMOTE_FRONTEND_DIR/" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ—Ä–æ–Ω—Ç–∞"; exit 1; }

# === 3. –ü–µ—Ä–µ–¥–∞—á–∞ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ë–ï–ó node_modules) ===
echo "üöÄ –ü–µ—Ä–µ–¥–∞—á–∞ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–µ–∑ node_modules)..."
rsync -avz --delete --exclude "node_modules" "$BACKEND_DIR/" "$SERVER_USER@$SERVER_IP:$REMOTE_BACKEND_DIR/" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –±—ç–∫–∞"; exit 1; }

# === 4. –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ===
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh "$SERVER_USER@$SERVER_IP" << EOF
  set -e
  echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ —Ñ–∞–π–ª—ã..."
  chown -R www-data:www-data "$SERVER_PATH"

  echo "üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±—ç–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
  cd "$REMOTE_BACKEND_DIR"
  rm -rf node_modules
  npm install --production || { echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"; exit 1; }

  echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω)..."
  pkill -f "node server.js" || echo "‚ö†Ô∏è –ë—ç–∫–µ–Ω–¥ –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

  echo "üõ† –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Node.js..."
  nohup node server.js > server.log 2>&1 &

  echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
  nginx -t && systemctl restart nginx

  echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω! –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –±—ç–∫–µ–Ω–¥ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! üéâ"
EOF
